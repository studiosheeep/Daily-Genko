<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ÂéüÁ®ø„Éû„ÉÉ„Éó</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- favicon 404 ÂØæÁ≠ñÔºàÂ∞è„Åï„Å™Á∑ë‰∏∏„Ç¢„Ç§„Ç≥„É≥Ôºâ -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='14' fill='%2322c55e'/%3E%3C/svg%3E">

  <style>
    :root {
      color-scheme: dark;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #020617;
      color: #e5e7eb;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 4px;
      color: #f9fafb;
    }
    .app-container {
      max-width: 960px;
      margin: 0 auto;
      background: radial-gradient(circle at top left, #1f2937 0, #020617 55%);
      border-radius: 24px;
      box-shadow:
        0 24px 60px rgba(0,0,0,0.55),
        0 0 0 1px rgba(15,23,42,0.9);
      padding: 18px 16px 20px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      padding: 10px 16px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-radius: 20px;
      box-shadow:
        0 14px 30px rgba(0, 0, 0, 0.45),
        0 0 0 1px rgba(21, 128, 61, 0.6);
      color: #fff;
    }

    .top-bar-left {
      flex: 1 1 auto;
      min-width: 180px;
    }

    .top-bar-left h1#nextTaskTitle {
      font-size: 18px;
      font-weight: 800;
      margin: 0 0 2px;
      color: #fff;
    }

    .top-bar-info {
      font-size: 12px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }

    .top-bar-right {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
      flex: 0 0 auto;
    }

    @media (max-width: 600px) {
      .top-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .top-bar-right {
        justify-content: flex-end;
        align-self: stretch;
      }
    }
    
    .streak-box {
      border-radius: 14px;
      padding: 6px 10px;
      font-size: 10px;
      background: rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      text-align: right;
      box-shadow: none;
    }

    .streak-label {
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 1px;
    }

    .streak-value {
      font-size: 16px;
      font-weight: 800;
      color: #fef9c3;
    }

    .streak-note {
      color: rgba(255, 255, 255, 0.8);
      font-size: 9px;
      margin-top: 2px;
    }

    .reset-btn {
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.8);
      background: rgba(255, 255, 255, 0.12);
      color: #ffffff;
      padding: 6px 14px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 3px 0 rgba(22, 101, 52, 0.7);
    }

    .reset-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .reset-btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 0 rgba(22, 101, 52, 0.7);
    }

    .page-nav {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
      color: #e5e7eb;
    }
    .page-nav button {
      border: 1px solid #1f2937;
      background: #020617;
      border-radius: 999px;
      padding: 4px 12px;
      font-size: 12px;
      cursor: pointer;
      color: #e5e7eb;
      box-shadow: 0 2px 0 rgba(15,23,42,0.9);
    }
    .page-nav button:hover:not(:disabled) {
      background: #111827;
    }
    .page-nav button:active:not(:disabled) {
      transform: translateY(1px);
      box-shadow: 0 1px 0 rgba(15,23,42,0.9);
    }
    .page-nav button:disabled {
      opacity: 0.35;
      cursor: default;
      box-shadow: none;
    }
    .page-nav-label {
      min-width: 150px;
      text-align: center;
      font-weight: 500;
      color: #e5e7eb;
    }

    .page-reset-btn {
      border: 1px solid #881337;
      background: #450a0a;
      color: #fecaca;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 0 2px 0 rgba(15,23,42,0.6);
    }

    .page-reset-btn:hover {
      background: #7f1d1d;
    }

    .page-reset-btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 0 rgba(15,23,42,0.6);
    }    
    
    .board-wrapper {
      margin-bottom: 4px;
      position: relative;
    }
    .map {
      position: relative;
      width: 100%;
      padding-bottom: 160%;
      border-radius: 20px;
      background:
        radial-gradient(circle at 20% 0%, rgba(56,189,248,0.12) 0, transparent 55%),
        radial-gradient(circle at 80% 90%, rgba(34,197,94,0.16) 0, transparent 55%),
        #020617;
      box-shadow:
        inset 0 0 0 1px rgba(15,23,42,0.8),
        0 18px 40px rgba(0,0,0,0.7);
      overflow: hidden;
    }
    @media (max-width: 600px) {
      .map {
        padding-bottom: 500%;
      }
    }

    .map::before {
      content: "";
      position: absolute;
      inset: 10% 6%;
      background-image: radial-gradient(circle, rgba(148,163,184,0.16) 1px, transparent 1px);
      background-size: 30px 30px;
      opacity: 0.35;
      pointer-events: none;
      z-index: 0;
    }

    .map-lines {
      position: absolute;
      inset: 0;
      z-index: 1;
      pointer-events: none;
    }
    .map-line {
      fill: none;
      stroke: rgba(34,197,94,0.85);
      stroke-width: 6;
      stroke-linecap: round;
      stroke-linejoin: round;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.75));
    }

    .node {
      position: absolute;
      transform: translate(-50%, -50%);
      min-width: 80px;
      text-align: center;
      z-index: 3;
    }
    .node.locked {
      cursor: default;
    }
    .node.unlocked,
    .node.completed {
      cursor: pointer;
    }

    .node-circle {
      width: 72px;
      height: 72px;
      margin: 0 auto 6px;
      border-radius: 999px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      transition:
        transform 0.12s ease,
        box-shadow 0.12s ease,
        background 0.12s ease,
        color 0.12s ease;
      box-shadow: 0 4px 0 rgba(15,23,42,0.9);
      position: relative;
    }
    .node.locked .node-circle {
      background: #0b1220;
      color: #4b5563;
      box-shadow: 0 3px 0 rgba(15,23,42,0.9);
      border: 1px solid #111827;
    }
    .node.unlocked .node-circle {
      background: #22c55e;
      color: #052e16;
      box-shadow:
        0 4px 0 rgba(15,23,42,0.9),
        0 0 0 4px rgba(34,197,94,0.25);
    }
    .node.completed .node-circle {
      background: #16a34a;
      color: #ecfdf3;
      box-shadow:
        0 5px 0 rgba(15,23,42,0.9),
        0 0 0 5px rgba(22,163,74,0.35);
      transform: translateY(-1px) scale(1.03);
    }
    .node.unlocked:hover .node-circle,
    .node.completed:hover .node-circle {
      transform: translateY(-2px) scale(1.04);
      box-shadow:
        0 7px 14px rgba(0,0,0,0.9),
        0 0 0 5px rgba(34,197,94,0.4);
    }

    .node-title {
      font-size: 16px;
      margin-bottom: 2px;
      color: #e5e7eb;
    }
    .node-progress {
      font-size: 9px;
      color: #9ca3af;
    }

    @media (max-width: 600px) {
      .node-title {
        font-size: 12px;
      }
    }

    .next-node .node-circle::after {
      content: "";
      position: absolute;
      inset: -6px;
      border-radius: inherit;
      border: 3px solid rgba(190, 242, 100, 0.9);
      opacity: 0;
      transform: scale(0.9);
      pointer-events: none;
      animation: node-ring 1.4s ease-out infinite;
    }

    @keyframes node-ring {
      0% {
        opacity: 0;
        transform: scale(0.7);
      }
      25% {
        opacity: 1;
        transform: scale(1.02);
      }
      80% {
        opacity: 0;
        transform: scale(1.35);
      }
      100% {
        opacity: 0;
        transform: scale(1.4);
      }
    }
    
    .success-toast {
      position: absolute;
      left: 50%;
      top: 16%;
      transform: translate(-50%, -50%) scale(0.7);
      background: #22c55e;
      color: #022c22;
      font-size: 13px;
      font-weight: 700;
      padding: 6px 18px;
      border-radius: 999px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.75);
      pointer-events: none;
      opacity: 0;
      z-index: 5;
    }
    .success-toast.show {
      animation: success-pop 0.9s ease-out forwards;
    }
    @keyframes success-pop {
      0% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.6);
      }
      20% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.05);
      }
      60% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }
    }
    
    .confetti {
      position: absolute;
      width: 6px;
      height: 10px;
      border-radius: 2px;
      opacity: 0;
      pointer-events: none;
      z-index: 4;
      animation: confetti-fall 900ms linear forwards;
    }

    @keyframes confetti-fall {
      0% {
        opacity: 0;
        transform: translate3d(0, 0, 0) rotateZ(0deg);
      }
      20% {
        opacity: 1;
        transform: translate3d(0, -80px, 0) rotateZ(120deg);
      }
      100% {
        opacity: 0;
        transform: translate3d(0, 260px, 0) rotateZ(360deg);
      }
    }

    /* ===== „Çµ„Ç§„Éâ„Éë„Éç„É´ ===== */
    .side-panel {
      position: fixed;
      top: 80px;
      right: 16px;
      width: 260px;
      max-width: 80vw;
      background: #020617;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.6);
      box-shadow: 0 20px 40px rgba(0,0,0,0.7);
      padding: 10px 12px 12px;
      font-size: 13px;
      opacity: 0;
      transform: translateX(16px);
      pointer-events: none;
      transition:
        opacity 0.16s ease-out,
        transform 0.16s ease-out;
      z-index: 30;
    }

    .side-panel.open {
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;
    }

    .side-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .side-panel-title {
      font-size: 14px;
      font-weight: 700;
      color: #e5e7eb;
    }

    .side-panel-close {
      border: none;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
      padding: 0 4px;
    }

    .side-panel-close:hover {
      color: #e5e7eb;
    }

    .side-panel-body {
      font-size: 12px;
      color: #cbd5f5;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .side-panel-done-btn {
      margin-top: 10px;
      width: 100%;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #022c22;
      font-size: 12px;
      font-weight: 700;
      padding: 6px 0;
      cursor: pointer;
      box-shadow: 0 3px 0 rgba(21,128,61,0.8);
    }

    .side-panel-done-btn:active {
      transform: translateY(1px);
      box-shadow: 0 1px 0 rgba(21,128,61,0.8);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="top-bar">
      <div class="top-bar-left">
        <h1 id="nextTaskTitle">ÂéüÁ®ø„Åô„Åî„Çç„Åè„Éû„ÉÉ„Éó</h1>
        <div class="top-bar-info" id="nextTaskInfo">
          ‰∏ÄÁï™‰∏ä„ÅÆ„Éû„Çπ„Åã„ÇâÈ†ÜÁï™„Å´„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÄ≤„ÇÅ„Å¶„ÅÑ„ÅèÂéüÁ®ø„Åô„Åî„Çç„Åè„Åß„Åô„ÄÇ
        </div>
      </div>
      <div class="top-bar-right">
        <div class="streak-box">
          <div class="streak-label">ÁèæÂú®„ÅÆÈÄ£Á∂öÊó•Êï∞</div>
          <div class="streak-value" id="streakValue">0 Êó•</div>
          <div class="streak-note">‚ÄªÊúù5ÊôÇÂå∫Âàá„Çä„Åß„Ç´„Ç¶„É≥„Éà</div>
        </div>
        <button class="reset-btn" id="resetProgressBtn">ÈÄ≤Êçó„ÉªÈÄ£Á∂öÊó•Êï∞„Çí„É™„Çª„ÉÉ„Éà</button>
      </div>
    </div>

    <div class="page-nav">
      <button id="prevPageBtn">‚óÄ</button>
      <span id="pageLabel" class="page-nav-label">1„Éö„Éº„Ç∏ÁõÆ / ÂÖ®1„Éö„Éº„Ç∏</span>
      <button id="nextPageBtn">‚ñ∂</button>
      <button id="addPageBtn">Ôºã</button>
      <button id="resetPagesBtn" class="page-reset-btn">üóë</button>
    </div>

    <div class="board-wrapper">
      <div id="map" class="map"></div>
      <div id="successToast" class="success-toast">„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ</div>
    </div>
  </div>

  <!-- ‚òÖ „Çµ„Ç§„Éâ„Éë„Éç„É´Êú¨‰Ωì -->
  <div id="sidePanel" class="side-panel">
    <div class="side-panel-header">
      <div id="sidePanelTitle" class="side-panel-title"></div>
      <button id="sidePanelClose" class="side-panel-close">√ó</button>
    </div>
    <div id="sidePanelBody" class="side-panel-body"></div>
    <button id="sidePanelDoneBtn" class="side-panel-done-btn">ÈÄ≤„ÇÅ„Åü</button>
  </div>

  <script>
    const frameCount   = 6;
    const roughCount   = 6;
    const textCount    = 6;
    const penCount     = 6;
    const betaCount    = 6;
    const toneCount    = 6;
    const finishCount  = 6;

    const LESSONS = [];

    function addGroup(prefix, label, descBase, count, prevId) {
      let lastId = prevId;
      for (let i = 1; i <= count; i++) {
        const id = `${prefix}${i}`;
        const title = `${label}${i}„Ç≥„ÉûÁõÆ`;
        LESSONS.push({
          id,
          title,
          description: descBase.replace("{n}", i),
          maxProgress: 1,
          prereqId: lastId
        });
        lastId = id;
      }
      return lastId;
    }

    let last = null;
    last = addGroup("frame_",  "Êû†Á∑ö",   "Êû†Á∑ö {n}„Ç≥„ÉûÁõÆ„ÄÇ",      frameCount, last);
    last = addGroup("rough_",  "‰∏ãÊõ∏„Åç", "‰∏ãÊõ∏„Åç {n}„Ç≥„ÉûÁõÆ„ÄÇ",    roughCount, last);
    last = addGroup("text_",   "Âè∞Ë©û",   "Âè∞Ë©û {n}„Ç≥„ÉûÁõÆ„ÄÇ",      textCount,  last);
    last = addGroup("pen_",    "„Éö„É≥ÂÖ•„Çå", "„Éö„É≥ÂÖ•„Çå {n}„Ç≥„ÉûÁõÆ„ÄÇ", penCount,   last);
    last = addGroup("beta_",   "„Éô„Çø",     "„Éô„Çø {n}„Ç≥„ÉûÁõÆ„ÄÇ",     betaCount,  last);
    last = addGroup("tone_",   "„Éà„Éº„É≥",   "„Éà„Éº„É≥ {n}„Ç≥„ÉûÁõÆ„ÄÇ",   toneCount,  last);
    last = addGroup("finish_", "‰ªï‰∏ä„Åí",   "‰ªï‰∏ä„Åí {n}„Ç≥„ÉûÁõÆ„ÄÇ",   finishCount,last);

    let currentPage = 1;
    const STORAGE_KEY = "mangaLessonProgress_v8_pages";
    const STREAK_KEY  = "mangaLessonStreak_v1";

    function createInitialProgressMap() {
      const obj = {};
      for (const lesson of LESSONS) {
        obj[lesson.id] = 0;
      }
      return obj;
    }

    function createNewData() {
      return {
        maxPage: 1,
        pages: { "1": createInitialProgressMap() }
      };
    }

    function migrateLegacyProgress(legacyObj) {
      const base = createInitialProgressMap();
      for (const id of Object.keys(base)) {
        if (typeof legacyObj[id] === "number") {
          base[id] = legacyObj[id];
        }
      }
      return base;
    }

    function loadAllProgress() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        const data = createNewData();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        return data;
      }
      try {
        const parsed = JSON.parse(raw);
        if (parsed && parsed.pages) {
          for (let p = 1; p <= (parsed.maxPage || 1); p++) {
            const key = String(p);
            if (!parsed.pages[key]) parsed.pages[key] = createInitialProgressMap();
            else {
              const base = createInitialProgressMap();
              const src = parsed.pages[key];
              for (const id of Object.keys(base)) {
                base[id] = typeof src[id] === "number" ? src[id] : 0;
              }
              parsed.pages[key] = base;
            }
          }
          return parsed;
        } else {
          const legacy = (parsed && typeof parsed === "object") ? parsed : {};
          const data = createNewData();
          data.pages["1"] = migrateLegacyProgress(legacy);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          return data;
        }
      } catch {
        const data = createNewData();
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        return data;
      }
    }

    function saveAllProgress(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadPageProgress(page) {
      const data = loadAllProgress();
      const key = String(page);
      if (!data.pages[key]) {
        data.pages[key] = createInitialProgressMap();
        if (page > data.maxPage) data.maxPage = page;
        saveAllProgress(data);
      }
      return { data, progress: data.pages[key] };
    }

    function resetAllPagesProgress() {
      const data = loadAllProgress();
      for (let p = 1; p <= data.maxPage; p++) {
        data.pages[String(p)] = createInitialProgressMap();
      }
      saveAllProgress(data);
    }

    function getPerRow() {
      return window.innerWidth <= 600 ? 3 : 6;
    }

    function computeGridPositions(count, perRow) {
      const positions = [];
      const rows = Math.ceil(count / perRow);

      let marginX = (perRow === 3) ? 12 : 8;
      const usableX = 100 - marginX * 2;
      const stepX   = perRow > 1 ? usableX / (perRow - 1) : 0;

      let marginTop, totalY;
      if (perRow === 3) {
        marginTop = 5;
        totalY    = 90;
      } else {
        marginTop = 8;
        totalY    = 70;
      }
      const rowStep = rows > 1 ? totalY / (rows - 1) : 0;

      for (let i = 0; i < count; i++) {
        const row = Math.floor(i / perRow);
        const indexInRow = i % perRow;
        const isEvenRow = (row % 2 === 0);
        const col = isEvenRow ? indexInRow : perRow - 1 - indexInRow;

        const x = marginX + stepX * col;
        const y = marginTop + rowStep * row;
        positions.push({ x, y });
      }
      return positions;
    }

    function getLogicalDateKey(date = new Date()) {
      const d = new Date(date.getTime());
      const hour = d.getHours();
      if (hour < 5) d.setDate(d.getDate() - 1);

      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function keyToDate(key) {
      const [y, m, d] = key.split("-").map(Number);
      return new Date(y, m - 1, d);
    }

    function dateToKey(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function loadStreakData() {
      const raw = localStorage.getItem(STREAK_KEY);
      if (!raw) return {};
      try {
        const obj = JSON.parse(raw);
        return obj && typeof obj === "object" ? obj : {};
      } catch {
        return {};
      }
    }

    function saveStreakData(data) {
      localStorage.setItem(STREAK_KEY, JSON.stringify(data));
    }

    function resetStreakData() {
      saveStreakData({});
    }

    function registerActivity() {
      const data = loadStreakData();
      const todayKey = getLogicalDateKey();
      if (!data[todayKey]) {
        data[todayKey] = true;
        saveStreakData(data);
      }
    }

    function calcCurrentStreak() {
      const data = loadStreakData();
      const keys = Object.keys(data);
      if (keys.length === 0) return 0;

      const set = new Set(keys);
      let streak = 0;
      let d = keyToDate(getLogicalDateKey());
      while (true) {
        const key = dateToKey(d);
        if (set.has(key)) {
          streak += 1;
          d.setDate(d.getDate() - 1);
        } else {
          break;
        }
      }
      return streak;
    }

    function updateStreakDisplay() {
      const el = document.getElementById("streakValue");
      if (!el) return;
      el.textContent = `${calcCurrentStreak()} Êó•`;
    }

    function updatePageLabel(dataOpt) {
      const labelEl = document.getElementById("pageLabel");
      const prevBtn = document.getElementById("prevPageBtn");
      const nextBtn = document.getElementById("nextPageBtn");
      const data = dataOpt || loadAllProgress();
      if (!labelEl) return;
      labelEl.textContent = `${currentPage}„Éö„Éº„Ç∏ÁõÆ / ÂÖ®${data.maxPage}„Éö„Éº„Ç∏`;
      if (prevBtn) prevBtn.disabled = currentPage <= 1;
      if (nextBtn) nextBtn.disabled = currentPage >= data.maxPage;
    }

    function getNextIncompleteLesson(progress) {
      for (const lesson of LESSONS) {
        if (!isLessonCompleted(lesson, progress)) {
          return lesson;
        }
      }
      return null;
    }

    function updateNextTaskDisplay(progress) {
      const titleEl = document.getElementById("nextTaskTitle");
      const infoEl  = document.getElementById("nextTaskInfo");
      if (!titleEl || !infoEl) return;

      const next = getNextIncompleteLesson(progress);

      if (next) {
        titleEl.textContent = `${next.title}„ÇíÈÄ≤„ÇÅ„Çà„ÅÜÔºÅ`;
        infoEl.textContent  = `Ê¨°„ÅÆ„Éû„Çπ„ÅØ„Äå${next.title}„Äç„Åß„Åô„ÄÇ„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÄ≤„ÇÅ„Å¶„ÅÑ„Åç„Åæ„Åó„Çá„ÅÜ„ÄÇ`;
      } else {
        titleEl.textContent = "„Åì„ÅÆ„Éö„Éº„Ç∏„ÅØÂÖ®ÈÉ®„ÇØ„É™„Ç¢„Åó„Åæ„Åó„ÅüÔºÅ";
        infoEl.textContent  = "„ÅäÁñ≤„Çå„Åï„Åæ„Åß„Åó„Åü„ÄÇÊñ∞„Åó„ÅÑ„Éö„Éº„Ç∏„ÇíËøΩÂä†„Åó„Å¶Á∂ö„Åç„ÅÆÂéüÁ®ø„ÇíÈÄ≤„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇ";
      }
    }

    // „Éë„Éç„É´„Å´Ë°®Á§∫„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà„Çí‰Ωú„Çã
    function buildPanelText(lesson) {
      const lines = [];
      lines.push(`‰ªäÊó•„ÅØ„Äå${lesson.title}„Äç„ÇíÈÄ≤„ÇÅ„Å¶„Åø„Çà„ÅÜ„ÄÇ`);
      lines.push("");
      lines.push("Â∞è„Åï„Åè„Å¶„ÅÑ„ÅÑ„ÅÆ„Åß„ÄÅ‰ªä„Åß„Åç„ÇãÁØÑÂõ≤„Å†„ÅëÊâã„Çí‰ªò„Åë„Å¶„Åø„Çã„ÅÆ„Åå„Åä„Åô„Åô„ÇÅ„Åß„Åô„ÄÇ");
      lines.push("„Éª5ÂàÜ„Å†„Åë„Çø„Ç§„Éû„Éº„Çí„Åã„Åë„Å¶Êâã„ÇíÂãï„Åã„Åó„Å¶„Åø„Çã");
      lines.push("„ÉªËø∑„Å£„Åü„Çâ„Å®„Çä„ÅÇ„Åà„Åö„É©„ÉïÁ∑ö„Çí‰∏ÄÊú¨Âºï„ÅÑ„Å¶„Åø„Çã");
      lines.push("");
      lines.push("‰ΩúÊ•≠„Åå„Åß„Åç„Åü„Çâ„ÄÅ‰∏ã„ÅÆ„ÄåÈÄ≤„ÇÅ„Åü„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Éû„Çπ„ÇíÈÄ≤„ÇÅ„Åæ„Åó„Çá„ÅÜ„ÄÇ");
      return lines.join("\n");
    }
    
    let audioCtx = null;

    function showSuccessEffect() {
      const toast = document.getElementById("successToast");
      if (!toast) return;
      toast.classList.remove("show");
      void toast.offsetWidth;
      toast.classList.add("show");
    }

    function triggerConfetti(targetNode) {
      const mapEl = document.getElementById("map");
      if (!mapEl) return;

      const mapRect = mapEl.getBoundingClientRect();

      let baseXPercent = 50;
      let baseYPercent = 20;

      if (targetNode) {
        const nodeRect = targetNode.getBoundingClientRect();
        const centerX = (nodeRect.left + nodeRect.right) / 2 - mapRect.left;
        const centerY = (nodeRect.top + nodeRect.bottom) / 2 - mapRect.top;
        baseXPercent = (centerX / mapRect.width) * 100;
        baseYPercent = (centerY / mapRect.height) * 100;
      }

      const count  = 45;
      const colors = ["#22c55e", "#facc15", "#38bdf8", "#f97316", "#a855f7"];

      for (let i = 0; i < count; i++) {
        const piece = document.createElement("div");
        piece.className = "confetti";

        const offsetX = (Math.random() * 30) - 15;
        piece.style.left = (baseXPercent + offsetX) + "%";
        piece.style.top  = baseYPercent + "%";

        piece.style.backgroundColor = colors[i % colors.length];
        piece.style.animationDelay  = (Math.random() * 0.18) + "s";

        mapEl.appendChild(piece);

        setTimeout(() => piece.remove(), 1000);
      }
    }
    
    function playSuccessSound(isFinal) {
      try {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return;
        if (!audioCtx) audioCtx = new Ctx();
        const ctx = audioCtx;
        const now = ctx.currentTime;

        function tone(freq, start, duration, volume, type = "sine") {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = type;
          osc.frequency.setValueAtTime(freq, start);
          gain.gain.setValueAtTime(0.0001, start);
          gain.gain.exponentialRampToValueAtTime(volume, start + 0.03);
          gain.gain.exponentialRampToValueAtTime(0.0001, start + duration);
          osc.connect(gain).connect(ctx.destination);
          osc.start(start);
          osc.stop(start + duration + 0.02);
        }

        function sparkleNoise(start, duration, volume) {
          const bufferSize = duration * ctx.sampleRate;
          const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
          const data = noiseBuffer.getChannelData(0);
          for (let i = 0; i < bufferSize; i++) {
            data[i] = (Math.random() * 2 - 1) * 0.4;
          }
          const noise = ctx.createBufferSource();
          noise.buffer = noiseBuffer;
          const gain = ctx.createGain();
          gain.gain.setValueAtTime(volume, start);
          gain.gain.exponentialRampToValueAtTime(0.0001, start + duration);
          noise.connect(gain).connect(ctx.destination);
          noise.start(start);
          noise.stop(start + duration + 0.05);
        }

        if (!isFinal) {
          tone(1320, now, 0.25, 0.25, "sine");
          tone(660,  now + 0.02, 0.35, 0.18, "triangle");
          tone(880,  now + 0.02, 0.35, 0.18, "triangle");
          sparkleNoise(now, 0.25, 0.08);
          return;
        }

        const base = 523.25;
        const step = 0.12;
        tone(base,           now + 0.00, 0.4, 0.26, "triangle");
        tone(base * 1.25,    now + step, 0.4, 0.24, "triangle");
        tone(base * 1.5,     now + step*2, 0.4, 0.22, "triangle");
        tone(base * 2,       now + step*3, 0.5, 0.28, "sine");

        tone(261.63, now, 0.6, 0.20, "sine");
        sparkleNoise(now, 0.45, 0.12);

      } catch (e) {
        console.warn("audio error", e);
      }
    }

    function isLessonUnlocked(lesson, progress) {
      if (!lesson.prereqId) return true;
      const prereq = LESSONS.find(l => l.id === lesson.prereqId);
      if (!prereq) return true;
      return progress[prereq.id] >= prereq.maxProgress;
    }

    function isLessonCompleted(lesson, progress) {
      return progress[lesson.id] >= lesson.maxProgress;
    }

    // ÂÆüÈöõ„Å´ÈÄ≤Êçó„ÇíÈÄ≤„ÇÅ„Å¶Á¥ôÂêπÈõ™„Åô„ÇãÂá¶ÁêÜÔºàÂæìÊù•„ÅÆadvanceÔºâ
    function advanceLesson(lessonId) {
      const { data, progress } = loadPageProgress(currentPage);
      const lesson = LESSONS.find(l => l.id === lessonId);
      if (!lesson) return;

      if (!isLessonUnlocked(lesson, progress)) {
        logMessage(`„Äå${lesson.title}„Äç„ÅØ„Åæ„Å†ÂÖà„ÅÆ„Éû„Çπ„Åß„Åô„ÄÇÊâãÂâç„ÅÆ„Éû„Çπ„Åã„ÇâÈ†ÜÁï™„Å´ÈÄ≤„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
        return;
      }
      if (progress[lesson.id] >= lesson.maxProgress) {
        logMessage(`„Äå${lesson.title}„Äç„ÅØÊó¢„Å´„ÇØ„É™„Ç¢„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ`);
        return;
      }

      progress[lesson.id] += 1;
      saveAllProgress(data);

      logMessage(`„Äå${lesson.title}„Äç„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇÔºà${currentPage}„Éö„Éº„Ç∏ÁõÆÔºâ`);
      registerActivity();
      updateStreakDisplay();

      const isFinal = lesson.id === "finish_6";

      renderAll();

      const mapEl = document.getElementById("map");
      const targetNode = mapEl
        ? mapEl.querySelector(`.node[data-lesson-id="${lessonId}"]`)
        : null;

      showSuccessEffect();
      triggerConfetti(targetNode);
      playSuccessSound(isFinal);
    }
    
    function logMessage(text) {
      console.log(text);
    }

    // „Å©„ÅÆ„Éû„Çπ„ÇíÈÄ≤„ÇÅ„Çã„Åã„ÄÅ„Éë„Éç„É´„Åß‰øùÊåÅ„Åó„Å¶„Åä„Åè
    let pendingLessonId = null;

    function openLessonPanel(lessonId) {
      const { progress } = loadPageProgress(currentPage);
      const lesson = LESSONS.find(l => l.id === lessonId);
      if (!lesson) return;

      if (!isLessonUnlocked(lesson, progress)) {
        logMessage(`„Äå${lesson.title}„Äç„ÅØ„Åæ„Å†ÂÖà„ÅÆ„Éû„Çπ„Åß„Åô„ÄÇÊâãÂâç„ÅÆ„Éû„Çπ„Åã„ÇâÈ†ÜÁï™„Å´ÈÄ≤„ÇÅ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
        return;
      }
      if (isLessonCompleted(lesson, progress)) {
        logMessage(`„Äå${lesson.title}„Äç„ÅØÊó¢„Å´„ÇØ„É™„Ç¢„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ`);
        return;
      }

      const panel = document.getElementById("sidePanel");
      const titleEl = document.getElementById("sidePanelTitle");
      const bodyEl  = document.getElementById("sidePanelBody");
      if (!panel || !titleEl || !bodyEl) return;

      titleEl.textContent = lesson.title;
      bodyEl.textContent  = buildPanelText(lesson);

      pendingLessonId = lessonId;
      panel.classList.add("open");
    }

    function closeLessonPanel() {
      const panel = document.getElementById("sidePanel");
      if (panel) panel.classList.remove("open");
    }

    function renderMap(progress) {
      const mapEl = document.getElementById("map");
      mapEl.innerHTML = "";

      const perRow = getPerRow();
      const positions = computeGridPositions(LESSONS.length, perRow);

      const nextLesson = getNextIncompleteLesson(progress);

      LESSONS.forEach((lesson, index) => {
        const unlocked  = isLessonUnlocked(lesson, progress);
        const completed = isLessonCompleted(lesson, progress);
        const pos = positions[index];

        const node = document.createElement("div");
        node.className = "node";
        node.dataset.lessonId = lesson.id;
        node.style.left = pos.x + "%";
        node.style.top  = pos.y + "%";

        if (!unlocked) node.classList.add("locked");
        if (unlocked)  node.classList.add("unlocked");
        if (completed) node.classList.add("completed");

        if (nextLesson && lesson.id === nextLesson.id) {
          node.classList.add("next-node");
        }

        const circle = document.createElement("div");
        circle.className = "node-circle";
        circle.textContent = index + 1;

        const title = document.createElement("div");
        title.className = "node-title";
        title.textContent = lesson.title;

        const progressText = document.createElement("div");
        progressText.className = "node-progress";
        if (completed) {
          progressText.textContent = "„ÇØ„É™„Ç¢Ê∏à„Åø";
        } else if (unlocked) {
          progressText.textContent = "„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÈÄ≤„ÇÄ";
        } else {
          progressText.textContent = "„É≠„ÉÉ„ÇØ‰∏≠";
        }

        node.appendChild(circle);
        node.appendChild(title);
        node.appendChild(progressText);

        // „Åì„Åì„ÅßÁõ¥Êé•advance„Åõ„Åö„ÄÅ„Éë„Éç„É´„ÇíÈñã„Åè
        node.addEventListener("click", () => openLessonPanel(lesson.id));
        mapEl.appendChild(node);
      });

      requestAnimationFrame(drawLinesFromDom);
    }

    function drawLinesFromDom() {
      const mapEl = document.getElementById("map");
      if (!mapEl) return;

      const oldSvg = mapEl.querySelector(".map-lines");
      if (oldSvg) oldSvg.remove();

      const nodes = Array.from(mapEl.querySelectorAll(".node"));
      if (nodes.length < 2) return;

      const mapRect = mapEl.getBoundingClientRect();
      const centers = nodes.map(node => {
        const r = node.getBoundingClientRect();
        const cx = (r.left + r.right) / 2 - mapRect.left;
        const cy = (r.top + r.bottom) / 2 - mapRect.top;
        return { x: cx, y: cy };
      });

      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("class", "map-lines");
      svg.setAttribute("width", "100%");
      svg.setAttribute("height", "100%");
      svg.setAttribute("viewBox", `0 0 ${mapRect.width} ${mapRect.height}`);
      svg.setAttribute("preserveAspectRatio", "none");

      for (let i = 0; i < centers.length - 1; i++) {
        const p1 = centers[i];
        const p2 = centers[i + 1];
        const path = document.createElementNS(svgNS, "path");
        const d = `M ${p1.x} ${p1.y} L ${p2.x} ${p2.y}`;
        path.setAttribute("d", d);
        path.setAttribute("class", "map-line");
        svg.appendChild(path);
      }

      mapEl.insertBefore(svg, mapEl.firstChild);
    }

    function renderAll() {
      const { data, progress } = loadPageProgress(currentPage);
      renderMap(progress);
      updateStreakDisplay();
      updatePageLabel(data);
      updateNextTaskDisplay(progress);
    }

    window.addEventListener("DOMContentLoaded", () => {
      renderAll();

      document.getElementById("resetProgressBtn").addEventListener("click", () => {
        if (!confirm("Êú¨ÂΩì„Å´ÂÖ®„Éö„Éº„Ç∏„ÅÆÈÄ≤Êçó„Å®ÈÄ£Á∂öÊó•Êï∞„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü")) return;
        resetAllPagesProgress();
        resetStreakData();
        renderAll();
      });

      document.getElementById("prevPageBtn").addEventListener("click", () => {
        if (currentPage > 1) {
          currentPage--;
          renderAll();
        }
      });
      document.getElementById("nextPageBtn").addEventListener("click", () => {
        const data = loadAllProgress();
        if (currentPage < data.maxPage) {
          currentPage++;
          renderAll();
        }
      });
      document.getElementById("addPageBtn").addEventListener("click", () => {
        const data = loadAllProgress();
        const newPage = data.maxPage + 1;
        data.maxPage = newPage;
        data.pages[String(newPage)] = createInitialProgressMap();
        saveAllProgress(data);
        currentPage = newPage;
        logMessage(`${newPage}„Éö„Éº„Ç∏ÁõÆ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇ`);
        renderAll();
      });

      document.getElementById("resetPagesBtn").addEventListener("click", () => {
        if (!confirm("ÂÖ®„Éö„Éº„Ç∏„ÇíÂâäÈô§„Åó„Å¶ 1„Éö„Éº„Ç∏ÁõÆ„Å†„ÅëÊÆã„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü")) return;

        const data = loadAllProgress();
        data.maxPage = 1;
        data.pages = { "1": createInitialProgressMap() };

        saveAllProgress(data);

        currentPage = 1;
        renderAll();
        logMessage("„Éö„Éº„Ç∏Êï∞„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ");
      });

      // „Çµ„Ç§„Éâ„Éë„Éç„É´„ÅÆ„Éú„Çø„É≥
      const closeBtn = document.getElementById("sidePanelClose");
      const doneBtn  = document.getElementById("sidePanelDoneBtn");

      if (closeBtn) {
        closeBtn.addEventListener("click", () => {
          pendingLessonId = null;
          closeLessonPanel();
        });
      }
      if (doneBtn) {
        doneBtn.addEventListener("click", () => {
          if (!pendingLessonId) {
            closeLessonPanel();
            return;
          }
          const id = pendingLessonId;
          pendingLessonId = null;
          closeLessonPanel();
          advanceLesson(id);
        });
      }

      window.addEventListener("resize", () => {
        renderAll();
      });
    });
  </script>
</body>
</html>
